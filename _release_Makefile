CXX = g++
ARCH = -mtune=generic
#	ARCH = -march=core2
#	ARCH = -march=native


COFLAGS = $(ARCH) -O3 -pipe
CXXFLAGS = -Wall $(COFLAGS)

PROGRAMS = extractSamples getGeneExpression getWithinGeneExpression estimateExpression transposeLargeFile estimateDE getVariance estimateHyperPar getPPLR convertSamples parseAlignment getFoldChange
BOOSTFLAGS = -I .
OPENMP = -fopenmp -DSUPPORT_OPENMP

all: $(PROGRAMS)

extractSamples: extractSamples.cpp common.o ArgumentParser.o PosteriorSamples.o common.h
	$(CXX) $(CXXFLAGS) extractSamples.cpp common.o ArgumentParser.o PosteriorSamples.o -o extractSamples

getFoldChange: getFoldChange.cpp common.o ArgumentParser.o PosteriorSamples.o 
	$(CXX) $(CXXFLAGS) getFoldChange.cpp common.o ArgumentParser.o PosteriorSamples.o -o getFoldChange

getGeneExpression: getGeneExpression.cpp common.o ArgumentParser.o TranscriptInfo.o PosteriorSamples.o common.h
	$(CXX) $(CXXFLAGS) getGeneExpression.cpp common.o ArgumentParser.o TranscriptInfo.o PosteriorSamples.o -o getGeneExpression

getWithinGeneExpression: getWithinGeneExpression.cpp common.o ArgumentParser.o TranscriptInfo.o PosteriorSamples.o common.h
	$(CXX) $(CXXFLAGS) getWithinGeneExpression.cpp common.o ArgumentParser.o TranscriptInfo.o PosteriorSamples.o -o getWithinGeneExpression

parseAlignment: parseAlignment.cpp common.o ArgumentParser.o TranscriptInfo.o TranscriptSequence.o TranscriptExpression.o ReadDistribution.o samtools/sam.o
	$(CXX) $(CXXFLAGS) $(OPENMP) -Isamtools samtools/*.o common.o ArgumentParser.o TranscriptInfo.o TranscriptSequence.o TranscriptExpression.o ReadDistribution.o parseAlignment.cpp -lz -o parseAlignment

samtools/sam.o:
	make --directory samtools

convertSamples: convertSamples.cpp common.o ArgumentParser.o TranscriptInfo.o
	$(CXX) $(CXXFLAGS) convertSamples.cpp common.o ArgumentParser.o  TranscriptInfo.o -o convertSamples

getPPLR:  getPPLR.cpp common.o ArgumentParser.o PosteriorSamples.o
	$(CXX) $(CXXFLAGS) getPPLR.cpp common.o ArgumentParser.o PosteriorSamples.o -o getPPLR

estimateHyperPar: estimateHyperPar.cpp common.o PosteriorSamples.o ArgumentParser.o lowess.o TranscriptExpression.o 
	$(CXX) $(CXXFLAGS) $(BOOSTFLAGS) estimateHyperPar.cpp common.o PosteriorSamples.o ArgumentParser.o TranscriptExpression.o lowess.o -o estimateHyperPar

estimateDE:  estimateDE.cpp common.o PosteriorSamples.o ArgumentParser.o
	$(CXX) $(CXXFLAGS) $(BOOSTFLAGS) estimateDE.cpp common.o PosteriorSamples.o ArgumentParser.o -o estimateDE

estimateExpression:  estimateExpression.cpp common.o ArgumentParser.o Sampler.o GibbsSampler.o CollapsedSampler.o GibbsParameters.o TranscriptInfo.o transposeFiles.o TagAlignments.o
	$(CXX) $(CXXFLAGS) $(BOOSTFLAGS) $(OPENMP) estimateExpression.cpp common.o ArgumentParser.o Sampler.o GibbsSampler.o CollapsedSampler.o GibbsParameters.o TranscriptInfo.o transposeFiles.o TagAlignments.o -o estimateExpression

getVariance:  getVariance.cpp common.o PosteriorSamples.o ArgumentParser.o
	$(CXX) $(CXXFLAGS) getVariance.cpp common.o PosteriorSamples.o ArgumentParser.o -o getVariance

transposeLargeFile: common.o transposeFiles.o ArgumentParser.o
	$(CXX) $(CXXFLAGS) transposeLargeFile.cpp common.o transposeFiles.o ArgumentParser.o -o transposeLargeFile

GibbsSampler.o: GibbsSampler.h GibbsSampler.cpp Sampler.o GibbsParameters.o
	$(CXX) $(CXXFLAGS) $(BOOSTFLAGS) -c GibbsSampler.cpp

CollapsedSampler.o: CollapsedSampler.h CollapsedSampler.cpp Sampler.o GibbsParameters.o
	$(CXX) $(CXXFLAGS) $(BOOSTFLAGS) -c CollapsedSampler.cpp

Sampler.o: Sampler.cpp Sampler.h GibbsParameters.o
	$(CXX) $(CXXFLAGS) $(BOOSTFLAGS) -c Sampler.cpp

ReadDistribution.o: ReadDistribution.cpp ReadDistribution.h TranscriptInfo.o TranscriptSequence.o TranscriptExpression.o 
	$(CXX) $(CXXFLAGS) $(OPENMP) -Isamtools -c ReadDistribution.cpp

TagAlignments.o: TagAlignments.cpp TagAlignments.h
transposeFiles.o: transposeFiles.cpp transposeFiles.h FileHeader.h
GibbsParameters.o: GibbsParameters.cpp GibbsParameters.h
ArgumentParser.o: ArgumentParser.cpp ArgumentParser.h
lowess.o: lowess.cpp lowess.h
TranscriptInfo.o: TranscriptInfo.cpp TranscriptInfo.h
TranscriptSequence.o: TranscriptSequence.cpp TranscriptSequence.h
TranscriptExpression.o: TranscriptExpression.cpp TranscriptExpression.h
PosteriorSamples.o: PosteriorSamples.cpp PosteriorSamples.h FileHeader.h
common.o: common.cpp common.h

clean:
	rm samtools/*.o *.o $(PROGRAMS)

